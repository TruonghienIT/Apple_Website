<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <style>
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    #editModal {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      backdrop-filter: blur(2px); z-index: 50; align-items: center;
      justify-content: center; padding: 1rem;
    }
    #editModal.active { display: flex; }
    #detailModal.hidden { display: none; }
    body {
    font-family: "SF Pro Text", -apple-system, BlinkMacSystemFont,
        "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans",
        "Helvetica Neue", sans-serif;
    }
    header {
        position: sticky;
        top: 0;  /* Đảm bảo header ở trên cùng */
        background-color:rgba(255, 255, 255, 0.7);  /* Thêm màu nền để dễ nhìn */
        z-index: 1000;  /* Đảm bảo header hiển thị trên các phần tử khác */
        width: 100%;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);  /* Tạo bóng mờ cho header */
    }
    /* Overlay modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    /* Nội dung modal */
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 30px;
      border-radius: 20px;
      width: 60%;
      position: relative;
    }

    /* Nút đóng */
    .modal .close {
      position: absolute;
      top: 10px; right: 20px;
      font-size: 24px;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-gray-100">
    <header class="w-full flex justify-center px-4 py-2 text-[20px] text-black/80">
    <nav>
      <ul class="flex items-center justify-center flex-wrap gap-4 sm:gap-6 relative">
        <!-- Logo -->
        <li>
          <a class="flex items-center" href="trangchu.html">
            <img alt="Apple logo black" class="block" height="45" src="Image/logo.webp" width="41" />
          </a>
        </li>

        <!-- Các menu chính -->
        <li><a class="hover:underline" href="Main.html">Cửa Hàng</a></li>
        <li class="relative group">
          <a class="hover:underline cursor-pointer" href="Mac.html">Mac</a>
          <ul class="absolute left-0 mt-2 hidden group-hover:flex flex-col bg-white border rounded-md shadow-md text-black w-40 z-10 transition-all duration-200">
            <li><a href="Mac.html#MacbookAir" class="block px-4 py-2 hover:bg-gray-100">Macbook Air</a></li>
            <li><a href="Mac.html#MacbookPro" class="block px-4 py-2 hover:bg-gray-100">Macbook Pro</a></li>
          </ul> 
        </li>

        <li class="relative group">
          <a class="hover:underline cursor-pointer" href="iPad.html">iPad</a>
          <ul class="absolute left-0 mt-2 hidden group-hover:flex flex-col bg-white border rounded-md shadow-md text-black w-40 z-10 transition-all duration-200">
            <li><a href="iPad.html#iPadPro" class="block px-4 py-2 hover:bg-gray-100">iPad Pro </a></li>
            <li><a href="iPad.html#iPadAir" class="block px-4 py-2 hover:bg-gray-100">iPad Air</a></li>
            <li><a href="iPad.html#iPadMini" class="block px-4 py-2 hover:bg-gray-100">iPad Mini</a></li>
            <li><a href="iPad.html#iPadGen" class="block px-4 py-2 hover:bg-gray-100">iPad Gen</a></li>
          </ul> 
        </li>

        <li class="group relative">
          <a class="hover:underline cursor-pointer" href="iPhone.html">iPhone</a>
          <ul class="absolute left-0 mt-2 hidden group-hover:flex flex-col bg-white border rounded-md shadow-md text-black w-40 z-10 transition-all duration-200">
            <li><a href="iPhone.html#iPhone15" class="block px-4 py-2 hover:bg-gray-100">iPhone 15</a></li>
            <li><a href="iPhone.html#iPhone14" class="block px-4 py-2 hover:bg-gray-100">iPhone 14</a></li>
            <li><a href="iPhone.html#iPhone13" class="block px-4 py-2 hover:bg-gray-100">iPhone 13</a></li>
            <li><a href="iPhone.html#iPhone12" class="block px-4 py-2 hover:bg-gray-100">iPhone 12</a></li>
            <li><a href="iPhone.html#iPhone11" class="block px-4 py-2 hover:bg-gray-100">iPhone 11</a></li>
          </ul>
        </li>

        <li class="group relative">
          <a class="hover:underline cursor-pointer" href="Watch.html">Watch</a>
          <ul class="absolute left-0 mt-2 hidden group-hover:flex flex-col bg-white border rounded-md shadow-md text-black w-40 z-10 transition-all duration-200">
            <li><a href="Watch.html#WatchSeries" class="block px-4 py-2 hover:bg-gray-100">Apple Watch Series</a></li>
            <li><a href="Watch.html#WatchSE" class="block px-4 py-2 hover:bg-gray-100">Apple Watch SE</a></li>
            <li><a href="Watch.html#WatchUltra" class="block px-4 py-2 hover:bg-gray-100">Apple Watch Ultra</a></li>
          </ul>
        </li>

        <li class="group relative">
          <a class="hover:underline cursor-pointer" href="AirPods.html">AirPods</a>
          <ul class="absolute left-0 mt-2 hidden group-hover:flex flex-col bg-white border rounded-md shadow-md text-black w-40 z-10 transition-all duration-200">
            <li><a href="AirPods.html#AirPods" class="block px-4 py-2 hover:bg-gray-100">AirPods</a></li>
            <li><a href="AirPods.html#AirPodsPro" class="block px-4 py-2 hover:bg-gray-100">AirPods Pro</a></li>
            <li><a href="AirPods.html#AirPodsMax" class="block px-4 py-2 hover:bg-gray-100">AirPods Max</a></li>
          </ul>
        </li>
        <li><a class="hover:underline" href="TV&Nha.html">TV &amp; Nhà</a></li>
        <li><a class="hover:underline" href="Giaitri.html">Giải Trí</a></li>
        <li><a class="hover:underline" href="Phukien.html">Phụ Kiện</a></li>
        <li><a class="hover:underline" href="Hotro.html">Hỗ Trợ</a></li>
      </ul>
    </nav>

    <!-- Tìm kiếm và đăng nhập -->
    <div class="hidden md:flex items-center space-x-4 text-gray-700 ml-6">
      <!-- Nút tìm kiếm -->
      <button 
        aria-label="Search" 
        class="hover:text-black" 
        onclick="toggleSearchForm()"
      >
        <i class="fas fa-search"></i>
      </button>

      <!-- Form tìm kiếm -->
      <div id="searchForm" class="hidden mt-4 w-full max-w-sm mx-auto">
        <form class="flex items-center" onsubmit="searchProduct(event)">
          <input 
            id="searchInput"
            type="text" 
            placeholder="Tìm kiếm sản phẩm..." 
            class="w-full px-3 py-2 text-sm text-black focus:outline-none" 
          />
          <button type="submit" class="bg-black text-white px-3 py-2 text-sm hover:bg-gray-800">
            Tìm
          </button>
        </form>
      </div>

      <!-- Icon người dùng -->
      <a href="profile.html">
        <button aria-label="User account" class="hover:text-black">
          <i class="fas fa-user"></i>
        </button>
      </a>
    </div>

    <div id="searchResults" class="mt-2 border p-4 rounded bg-white hidden relative">
      <button 
        onclick="closeSearchResults()" 
        class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 font-bold"
        aria-label="Đóng kết quả tìm kiếm"
      >
        &times;
      </button>
      <div id="searchResultsContent" class="flex space-x-4 overflow-x-auto max-w-full"></div>
    </div>

    <!-- Script toggle -->
    <script>
      function toggleSearchForm() {
          const form = document.getElementById('searchForm');
          form.classList.toggle('hidden');
      }

      // Hàm xử lý tìm kiếm sản phẩm
      function searchProduct(event) {
        event.preventDefault();

        const query = document.getElementById('searchInput').value;
        const resultsDiv = document.getElementById('searchResults');
        const resultsContent = document.getElementById('searchResultsContent');

        resultsDiv.classList.remove('hidden');
        resultsContent.innerHTML = "Đang tìm kiếm...";

        fetch('../backend/search.php?query=' + encodeURIComponent(query))
            .then(response => response.text())
            .then(data => {
                resultsContent.innerHTML = data;
            })
            .catch(error => {
                resultsContent.innerHTML = "Đã xảy ra lỗi khi tìm kiếm.";
                console.error("Lỗi:", error);
            });
          }

          // Hàm ẩn kết quả tìm kiếm khi bấm nút đóng
          function closeSearchResults() {
              const resultsDiv = document.getElementById('searchResults');
              resultsDiv.classList.add('hidden');
              // Nếu muốn, xóa nội dung cũ
              document.getElementById('searchResultsContent').innerHTML = "";
          }
      </script>
  </header>

  <div class="max-w-4xl mx-auto mt-10 bg-white shadow-md p-6 rounded-lg">
    <div class="flex items-center space-x-6">
      <img id="avatar" src="default-avatar.jpg" alt="avatar" class="w-24 h-24 rounded-full object-cover border border-gray-300" />
      <div>
        <h2 id="fullname" class="text-2xl font-semibold">Đang tải...</h2>
        <p id="email" class="text-gray-600"></p>
        <div class="mt-4 flex space-x-2">
          <button id="editProfileBtn" class="px-4 py-2 bg-pink-600 text-white rounded hover:bg-pink-700">Sửa hồ sơ</button>
          <button class="px-4 py-2 bg-gray-300 rounded">Giỏ Hàng</button>
          <button onclick="window.location.href='dangnhap.html'" class="px-4 py-2 bg-gray-300 rounded" title="Đăng xuất">
            <i class="fas fa-door-open"></i>
          </button> 
          <button id="showDetailBtn" class="px-4 py-2 bg-gray-300 rounded" title="Chi tiết hồ sơ">🔗</button>  
        </div>
      </div>
    </div>

    <div class="mt-6 grid grid-cols-3 gap-4 text-center text-gray-700">
      <div><strong id="countPurchased">0</strong><br />Đã Mua</div>
      <div><strong id="countCart">0</strong><br />Giỏ Hàng</div>
      <div><strong id="countFollowing">0</strong><br />Theo Dõi</div>
    </div>
  </div>

  <!-- Vùng hiển thị giỏ hàng -->
  <div class="max-w-4xl mx-auto mt-6 bg-white p-6 rounded-lg shadow">
    <h3 class="text-xl font-bold mb-4 text-pink-600">🛒 Sản phẩm trong giỏ hàng</h3>
    <div id="cartItems" class="space-y-4">
      <p>Đang tải giỏ hàng...</p>
    </div>
    <div class="mt-4 border-t pt-4 flex justify-between items-center">
      <p class="text-lg font-semibold text-gray-700">Tổng cộng: <span id="totalAmount">0₫</span></p>
      <button onclick="openCheckoutModal()" class="bg-blue-500 text-white px-4 py-2 rounded">Thanh toán</button>
    </div>
  </div>
  

  <!-- Modal sửa hồ sơ -->
  <div id="editModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="bg-white rounded-lg p-6 max-w-md w-full shadow-lg relative">
      <h3 class="text-xl font-semibold mb-4">Sửa Hồ Sơ</h3>
      <form id="editProfileForm" enctype="multipart/form-data">
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="inputFullname">Họ và tên</label>
          <input type="text" name="fullname" id="inputFullname" required class="w-full border px-3 py-2 rounded" />
        </div>
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="inputEmail">Email</label>
          <input type="email" name="email" id="inputEmail" required class="w-full border px-3 py-2 rounded" />
        </div>
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="inputPhone">Số điện thoại</label>
          <input type="text" name="phone" id="inputPhone" class="w-full border px-3 py-2 rounded" />
        </div>
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="inputAddress">Địa chỉ</label>
          <input type="text" name="address" id="inputAddress" class="w-full border px-3 py-2 rounded" />
        </div>
        <div class="mb-4">
          <label class="block mb-1 font-medium">Ảnh đại diện mới (nếu muốn)</label>
          <input type="file" name="avatar" accept="image/*" />
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" id="cancelBtn" class="px-4 py-2 border rounded">Hủy</button>
          <button type="submit" class="px-4 py-2 bg-pink-600 text-white rounded hover:bg-pink-700">Lưu</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal chi tiết hồ sơ -->
  <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-lg max-w-xl w-full shadow-lg relative">
      <button id="closeDetailBtn" class="absolute top-2 right-2 text-gray-500 hover:text-red-500 text-xl">&times;</button>
      <h3 class="text-xl font-bold text-pink-600 mb-4">Chi tiết hồ sơ</h3>

      <div class="flex items-center space-x-4 mb-4">
        <img id="detailAvatar" src="default-avatar.jpg" class="w-20 h-20 rounded-full border object-cover" alt="Avatar">
        <div>
          <p id="detailFullname" class="font-semibold text-lg">Họ tên</p>
          <p id="detailEmail" class="text-gray-500 text-sm">Email</p>
        </div>
      </div>

      <div class="space-y-2 text-sm text-gray-700">
        <p><strong>Tên đăng nhập:</strong> <span id="detailUsername">-</span></p>
        <p><strong>Giới tính:</strong> <span id="detailGender">-</span></p>
        <p><strong>Điện thoại:</strong> <span id="detailPhone">-</span></p>
        <p><strong>Địa chỉ:</strong> <span id="detailAddress">-</span></p>
      </div>
    </div>
  </div>

  <!-- Modal thanh toán-->
  <div id="checkoutModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg w-full max-w-2xl">
      <h2 class="text-xl font-semibold mb-4">Xác nhận thanh toán</h2>

      <!-- Thông tin người dùng -->
      <div class="mb-4">
        <p><strong>Người nhận:</strong> <span id="checkoutUserName"></span></p>
        <p><strong>Số điện thoại:</strong> <span id="checkoutUserPhone"></span></p>
        <p><strong>Địa chỉ:</strong> <span id="checkoutUserAddress"></span></p>
      </div>

      <!-- Bảng sản phẩm -->
      <div class="overflow-x-auto mb-4">
        <table class="w-full border">
          <thead>
            <tr class="bg-gray-100">
              <th class="border px-2 py-1">Sản phẩm</th>
              <th class="border px-2 py-1">Số lượng</th>
              <th class="border px-2 py-1">Giá</th>
              <th class="border px-2 py-1">Tổng</th>
            </tr>
          </thead>
          <tbody id="checkoutCartItems"></tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="text-right font-bold px-2 py-1 border">Tổng tiền:</td>
              <td id="checkoutTotal" class="border px-2 py-1"></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Phương thức thanh toán -->
      <div class="mb-4">
        <label class="block font-semibold mb-1">Phương thức thanh toán:</label>
        <select id="paymentMethod" class="border px-2 py-1 rounded w-full">
          <option value="COD">Thanh toán khi nhận hàng</option>
          <option value="BANK">Chuyển khoản</option>
          <option value="MOMO">Momo</option>
        </select>
      </div>

      <!-- Ghi chú -->
      <div class="mb-4">
        <label class="block font-semibold mb-1">Ghi chú:</label>
        <textarea id="orderNote" class="w-full border px-2 py-1 rounded" rows="3"></textarea>
      </div>

      <!-- Nút hành động -->
      <div class="flex justify-end gap-2">
        <button onclick="closeCheckoutModal()" class="px-4 py-2 bg-gray-400 text-white rounded">Hủy</button>
        <button onclick="submitCheckout()" class="px-4 py-2 bg-green-500 text-white rounded">Xác nhận</button>
      </div>
    </div>
  </div>

  <script>
    // Hàm tải thông tin hồ sơ người dùng
    function loadProfile() {
    fetch('http://localhost/Web%20Apple/backend/get_profile.php', {
      credentials: 'include'
    })
    .then(res => res.json())
    .then(data => {
      console.log("Profile data:", data); // Debug dữ liệu trả về

      if (data.error || !data.user) {
        alert(data.error || "Không lấy được thông tin người dùng");
        return;
      }
      const user = data.user;
      document.getElementById("avatar").src = user.image || "default-avatar.jpg";
      document.getElementById("fullname").textContent = user.fullname || "Chưa có tên";
      document.getElementById("email").textContent = user.email || "Chưa có email";

      document.getElementById("inputFullname").value = user.fullname || "";
      document.getElementById("inputEmail").value = user.email || "";
      document.getElementById("inputPhone").value = user.phone || "";
      document.getElementById("inputAddress").value = user.address || "";

      if (data.stats) {
        // Nếu stats.purchased là undefined hoặc null thì giữ nguyên giá trị cũ hoặc hiển thị 0
        const purchased = (data.stats.purchased !== undefined && data.stats.purchased !== null) ? data.stats.purchased : 0;
        document.getElementById("countPurchased").textContent = purchased;
        document.getElementById("countCart").textContent = data.stats.cart || 0;
        document.getElementById("countFollowing").textContent = data.stats.following || 0;
      }
    })
    .catch(() => alert("Lỗi khi tải dữ liệu hồ sơ"));
  }

    // Hàm tải danh sách sản phẩm trong giỏ hàng
    function loadCartItems() {
      fetch("http://localhost/Web%20Apple/backend/get_cart_items.php", { credentials: "include" })
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById("cartItems");
          const countElement = document.getElementById("countCart");

          if (!data.success) {
            container.innerHTML = `<p class="text-red-600">${data.message || "Lỗi tải giỏ hàng"}</p>`;
            countElement.textContent = "0";
            return;
          }

          if (!data.items || data.items.length === 0) {
            container.innerHTML = `<p class="text-gray-500">Giỏ hàng trống.</p>`;
            countElement.textContent = "0";
            document.getElementById("totalAmount").textContent = "0₫"; // reset tổng tiền về 0 khi 0 có sản phẩm nào trong giỏ hàng
            return;
          }

          container.innerHTML = "";
          const itemCount = data.items.length;
          countElement.textContent = itemCount;
          let totalAmount = 0;

          data.items.forEach(item => {
            const discount_price = parseInt(item.discount_price);
            const quantity = parseInt(item.quantity);
            totalAmount += discount_price * quantity;

            const card = document.createElement("div");
            card.className = "border rounded p-4 flex items-center gap-4";

            card.innerHTML = `
              <img src="${item.image}" class="w-20 h-20 object-cover rounded border" alt="${item.name}">
              <div class="flex-1">
                <h4 class="font-semibold">${item.name}</h4>
                <p class="text-sm text-gray-600">Số lượng: ${item.quantity}</p>
                <p class="text-sm text-gray-800 font-medium">Giá: ${item.discount_price}₫</p>
              </div>
              <input type="checkbox" class="checkout-item w-5 h-5" data-discount_price="${item.discount_price}" data-quantity="${item.quantity}" data-id="${item.id}" />
            `;

            container.appendChild(card);
          });
          document.getElementById("totalAmount").textContent = `${totalAmount.toLocaleString()}₫`;
        })
        .catch(err => {
          console.error("Lỗi:", err);
          document.getElementById("cartItems").innerHTML = `<p class="text-red-600">Không thể tải giỏ hàng.</p>`;
          document.getElementById("countCart").textContent = "0";
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("editModal");
      const editBtn = document.getElementById("editProfileBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const form = document.getElementById("editProfileForm");

      loadProfile();
      loadCartItems();

      editBtn.addEventListener("click", () => modal.classList.add("active"));
      cancelBtn.addEventListener("click", () => modal.classList.remove("active"));

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        fetch("http://localhost/Web%20Apple/backend/update_profile.php", {
          method: "POST",
          body: formData,
          credentials: "include"
        })
        .then(res => res.json())
        .then(data => {
          if(data.success) {
            alert(data.message || "Cập nhật hồ sơ thành công");
            modal.classList.remove("active");
            loadProfile();
          } else {
            alert("Lỗi: " + (data.message || "Không thể cập nhật"));
          }
        })
        .catch(() => alert("Lỗi khi gửi dữ liệu"));
      });

      modal.addEventListener("click", (e) => {
        if(e.target === modal) modal.classList.remove("active");
      });

      const detailModal = document.getElementById("detailModal");
      document.getElementById("showDetailBtn").addEventListener("click", () => {
        fetch("http://localhost/Web%20Apple/backend/get_profile.php", { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          if(data.error || !data.user) {
            alert(data.error || "Không lấy được thông tin chi tiết");
            return;
          }
          const u = data.user;
          document.getElementById("detailAvatar").src = u.image || "default-avatar.jpg";
          document.getElementById("detailFullname").textContent = u.fullname || "-";
          document.getElementById("detailEmail").textContent = u.email || "-";
          document.getElementById("detailUsername").textContent = u.username || "-";
          document.getElementById("detailGender").textContent = u.gender || "-";
          document.getElementById("detailPhone").textContent = u.phone || "-";
          document.getElementById("detailAddress").textContent = u.address || "-";

          detailModal.classList.remove("hidden");
        })
        .catch(() => alert("Lỗi khi tải chi tiết hồ sơ"));
      });

      document.getElementById("closeDetailBtn").addEventListener("click", () => {
        detailModal.classList.add("hidden");
      });

      document.getElementById("checkoutBtn").addEventListener("click", () => {
        openCheckoutModal();
      });
    });

    function openCheckoutModal() {
      const checkedItems = document.querySelectorAll(".checkout-item:checked");
      if (checkedItems.length === 0) {
        alert("Vui lòng chọn ít nhất một sản phẩm để thanh toán.");
        return;
      }

      fetch('http://localhost/Web%20Apple/backend/get_profile.php', { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          if (data.error || !data.user) {
            alert(data.error || "Không lấy được thông tin người dùng");
            return;
          }

          const user = data.user;
          document.getElementById("checkoutUserName").textContent = user.fullname || "";
          document.getElementById("checkoutUserPhone").textContent = user.phone || "";
          document.getElementById("checkoutUserAddress").textContent = user.address || "";

          const tbody = document.getElementById("checkoutCartItems");
          tbody.innerHTML = "";

          let total = 0;
          checkedItems.forEach(item => {
            const container = item.closest("div");
            const name = container.querySelector("h4").textContent;
            const discount_price = parseInt(item.dataset.discount_price);
            const quantity = parseInt(item.dataset.quantity);
            const sum = discount_price * quantity;
            total += sum;

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="border px-2 py-1">${name}</td>
              <td class="border px-2 py-1 text-center">${quantity}</td>
              <td class="border px-2 py-1 text-right">${discount_price.toLocaleString()}₫</td>
              <td class="border px-2 py-1 text-right">${sum.toLocaleString()}₫</td>
            `;
            tbody.appendChild(tr);
          });

          document.getElementById("checkoutTotal").textContent = total.toLocaleString() + "₫";

          const modal = document.getElementById("checkoutModal");
          modal.classList.remove("hidden");
          modal.classList.add("flex");
        })
        .catch(() => alert("Lỗi tải thông tin người dùng"));
    }

    function closeCheckoutModal() {
      const modal = document.getElementById("checkoutModal");
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }

    function submitCheckout() {
      const paymentMethod = document.getElementById("paymentMethod").value;
      const orderNote = document.getElementById("orderNote").value;
      const checkedItems = document.querySelectorAll(".checkout-item:checked");

      if (checkedItems.length === 0) {
        alert("Không có sản phẩm để thanh toán.");
        return;
      }

      const product_ids = Array.from(checkedItems).map(item => parseInt(item.dataset.id));

      fetch("http://localhost/Web%20Apple/backend/checkout.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({
          payment_method: paymentMethod,
          note: orderNote,
          product_ids: product_ids
        })
      })
      .then(res => {
        if (!res.ok) throw new Error("HTTP error " + res.status);
        return res.json();
      })
      .then(data => {
        console.log("Response data:", data);
        if (data.success) {
          alert("Thanh toán thành công!");
          closeCheckoutModal();
          loadCartItems();
          if (data.purchased !== undefined) {
            const countPurchasedElem = document.getElementById("countPurchased");
            countPurchasedElem.textContent = data.purchased;
          }
        } else {
          alert("Lỗi thanh toán: " + (data.message || "Không xác định"));
        }
      })
      .catch(err => {
        console.error("Fetch error:", err);
        alert("Lỗi khi gửi yêu cầu thanh toán: " + err.message);
      });
    }
  </script>

</body> 
</html>
