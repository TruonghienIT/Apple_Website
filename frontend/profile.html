<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <style>
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    #editModal {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      backdrop-filter: blur(2px); z-index: 50; align-items: center;
      justify-content: center; padding: 1rem;
    }
    #editModal.active { display: flex; }
    #detailModal.hidden { display: none; }
  </style>
</head>
<body class="bg-gray-100">

  <div class="max-w-4xl mx-auto mt-10 bg-white shadow-md p-6 rounded-lg">
    <div class="flex items-center space-x-6">
      <img id="avatar" src="default-avatar.jpg" alt="avatar" class="w-24 h-24 rounded-full object-cover border border-gray-300" />
      <div>
        <h2 id="fullname" class="text-2xl font-semibold">ƒêang t·∫£i...</h2>
        <p id="email" class="text-gray-600"></p>
        <div class="mt-4 flex space-x-2">
          <button id="editProfileBtn" class="px-4 py-2 bg-pink-600 text-white rounded hover:bg-pink-700">S·ª≠a h·ªì s∆°</button>
          <button class="px-4 py-2 bg-gray-300 rounded">Gi·ªè H√†ng</button>
          <button onclick="window.location.href='dangnhap.html'" class="px-4 py-2 bg-gray-300 rounded" title="ƒêƒÉng xu·∫•t">
            <i class="fas fa-door-open"></i>
          </button> 
          <button id="showDetailBtn" class="px-4 py-2 bg-gray-300 rounded" title="Chi ti·∫øt h·ªì s∆°">üîó</button>  
        </div>
      </div>
    </div>

    <div class="mt-6 grid grid-cols-3 gap-4 text-center text-gray-700">
      <div><strong id="countPurchased">0</strong><br />ƒê√£ Mua</div>
      <div><strong id="countCart">0</strong><br />Gi·ªè H√†ng</div>
      <div><strong id="countFollowing">0</strong><br />Theo D√µi</div>
    </div>
  </div>

  <!-- V√πng hi·ªÉn th·ªã gi·ªè h√†ng -->
  <div class="max-w-4xl mx-auto mt-6 bg-white p-6 rounded-lg shadow">
    <h3 class="text-xl font-bold mb-4 text-pink-600">üõí S·∫£n ph·∫©m trong gi·ªè h√†ng</h3>
    <div id="cartItems" class="space-y-4">
      <p>ƒêang t·∫£i gi·ªè h√†ng...</p>
    </div>
    <div class="mt-4 border-t pt-4 flex justify-between items-center">
      <p class="text-lg font-semibold text-gray-700">T·ªïng c·ªông: <span id="totalAmount">0‚Ç´</span></p>
      <button id="checkoutBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
        Thanh to√°n
      </button>
    </div>
  </div>
  

  <!-- Modal s·ª≠a h·ªì s∆° -->
  <div id="editModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="bg-white rounded-lg p-6 max-w-md w-full shadow-lg relative">
      <h3 class="text-xl font-semibold mb-4">S·ª≠a H·ªì S∆°</h3>
      <form id="editProfileForm" enctype="multipart/form-data">
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="inputFullname">H·ªç v√† t√™n</label>
          <input type="text" name="fullname" id="inputFullname" required class="w-full border px-3 py-2 rounded" />
        </div>
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="inputEmail">Email</label>
          <input type="email" name="email" id="inputEmail" required class="w-full border px-3 py-2 rounded" />
        </div>
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="inputPhone">S·ªë ƒëi·ªán tho·∫°i</label>
          <input type="text" name="phone" id="inputPhone" class="w-full border px-3 py-2 rounded" />
        </div>
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="inputAddress">ƒê·ªãa ch·ªâ</label>
          <input type="text" name="address" id="inputAddress" class="w-full border px-3 py-2 rounded" />
        </div>
        <div class="mb-4">
          <label class="block mb-1 font-medium">·∫¢nh ƒë·∫°i di·ªán m·ªõi (n·∫øu mu·ªën)</label>
          <input type="file" name="avatar" accept="image/*" />
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" id="cancelBtn" class="px-4 py-2 border rounded">H·ªßy</button>
          <button type="submit" class="px-4 py-2 bg-pink-600 text-white rounded hover:bg-pink-700">L∆∞u</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal chi ti·∫øt h·ªì s∆° -->
  <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-lg max-w-xl w-full shadow-lg relative">
      <button id="closeDetailBtn" class="absolute top-2 right-2 text-gray-500 hover:text-red-500 text-xl">&times;</button>
      <h3 class="text-xl font-bold text-pink-600 mb-4">Chi ti·∫øt h·ªì s∆°</h3>

      <div class="flex items-center space-x-4 mb-4">
        <img id="detailAvatar" src="default-avatar.jpg" class="w-20 h-20 rounded-full border object-cover" alt="Avatar">
        <div>
          <p id="detailFullname" class="font-semibold text-lg">H·ªç t√™n</p>
          <p id="detailEmail" class="text-gray-500 text-sm">Email</p>
        </div>
      </div>

      <div class="space-y-2 text-sm text-gray-700">
        <p><strong>T√™n ƒëƒÉng nh·∫≠p:</strong> <span id="detailUsername">-</span></p>
        <p><strong>Gi·ªõi t√≠nh:</strong> <span id="detailGender">-</span></p>
        <p><strong>ƒêi·ªán tho·∫°i:</strong> <span id="detailPhone">-</span></p>
        <p><strong>ƒê·ªãa ch·ªâ:</strong> <span id="detailAddress">-</span></p>
      </div>
    </div>
  </div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("editModal");
      const editBtn = document.getElementById("editProfileBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const form = document.getElementById("editProfileForm");

      function loadProfile() {
        fetch('http://localhost/Web%20Apple/backend/get_profile.php', {
          credentials: 'include'
        })
        .then(res => res.json())
        .then(data => {
          if (data.error || !data.user) {
            alert(data.error || "Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin ng∆∞·ªùi d√πng");
            return;
          }
          const user = data.user;
          document.getElementById("avatar").src = user.image || "default-avatar.jpg";
          document.getElementById("fullname").textContent = user.fullname || "Ch∆∞a c√≥ t√™n";
          document.getElementById("email").textContent = user.email || "Ch∆∞a c√≥ email";

          document.getElementById("inputFullname").value = user.fullname || "";
          document.getElementById("inputEmail").value = user.email || "";
          document.getElementById("inputPhone").value = user.phone || "";
          document.getElementById("inputAddress").value = user.address || "";

          if (data.stats) {
            document.getElementById("countPurchased").textContent = data.stats.purchased || 0;
            document.getElementById("countCart").textContent = data.stats.cart || 0;
            document.getElementById("countFollowing").textContent = data.stats.following || 0;
          }
        })
        .catch(() => alert("L·ªói khi t·∫£i d·ªØ li·ªáu h·ªì s∆°"));
      }

      function loadCartItems() {
        fetch("http://localhost/Web%20Apple/backend/get_cart_items.php", { credentials: "include" })
          .then(res => res.json())
          .then(data => {
            const container = document.getElementById("cartItems");
            const countElement = document.getElementById("countCart");

            if (!data.success) {
              container.innerHTML = `<p class="text-red-600">${data.message || "L·ªói t·∫£i gi·ªè h√†ng"}</p>`;
              countElement.textContent = "0";
              return;
            }

            if (!data.items || data.items.length === 0) {
              container.innerHTML = `<p class="text-gray-500">Gi·ªè h√†ng tr·ªëng.</p>`;
              countElement.textContent = "0";
              return;
            }

            container.innerHTML = "";
            const itemCount = data.items.length;
            countElement.textContent = itemCount;
            let totalAmount = 0;

            data.items.forEach(item => {
              const price = parseInt(item.price);
              const quantity = parseInt(item.quantity);
              totalAmount += price * quantity;

              const card = document.createElement("div");
              card.className = "border rounded p-4 flex items-center gap-4";

              card.innerHTML = `
                <img src="${item.image}" class="w-20 h-20 object-cover rounded border" alt="${item.name}">
                <div class="flex-1">
                  <h4 class="font-semibold">${item.name}</h4>
                  <p class="text-sm text-gray-600">S·ªë l∆∞·ª£ng: ${item.quantity}</p>
                  <p class="text-sm text-gray-800 font-medium">Gi√°: ${item.price}‚Ç´</p>
                </div>
                <input type="checkbox" class="checkout-item w-5 h-5" data-price="${item.price}" data-quantity="${item.quantity}" data-id="${item.id}" />
              `;

              container.appendChild(card);
            });

            document.getElementById("totalAmount").textContent = `${totalAmount.toLocaleString()}‚Ç´`;
          })
          .catch(err => {
            console.error("L·ªói:", err);
            document.getElementById("cartItems").innerHTML = `<p class="text-red-600">Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng.</p>`;
            document.getElementById("countCart").textContent = "0";
          });
      }

      loadProfile();
      loadCartItems();

      editBtn.addEventListener("click", () => modal.classList.add("active"));
      cancelBtn.addEventListener("click", () => modal.classList.remove("active"));

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        fetch("http://localhost/Web%20Apple/backend/update_profile.php", {
          method: "POST",
          body: formData,
          credentials: "include"
        })
        .then(res => res.json())
        .then(data => {
          if(data.success) {
            alert(data.message || "C·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng");
            modal.classList.remove("active");
            loadProfile();
          } else {
            alert("L·ªói: " + (data.message || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t"));
          }
        })
        .catch(() => alert("L·ªói khi g·ª≠i d·ªØ li·ªáu"));
      });

      modal.addEventListener("click", (e) => {
        if(e.target === modal) modal.classList.remove("active");
      });

      const detailModal = document.getElementById("detailModal");
      document.getElementById("showDetailBtn").addEventListener("click", () => {
        fetch("http://localhost/Web%20Apple/backend/get_profile.php", { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          if(data.error || !data.user) {
            alert(data.error || "Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin chi ti·∫øt");
            return;
          }
          const u = data.user;
          document.getElementById("detailAvatar").src = u.image || "default-avatar.jpg";
          document.getElementById("detailFullname").textContent = u.fullname || "-";
          document.getElementById("detailEmail").textContent = u.email || "-";
          document.getElementById("detailUsername").textContent = u.username || "-";
          document.getElementById("detailGender").textContent = u.gender || "-";
          document.getElementById("detailPhone").textContent = u.phone || "-";
          document.getElementById("detailAddress").textContent = u.address || "-";

          detailModal.classList.remove("hidden");
        })
        .catch(() => alert("L·ªói khi t·∫£i chi ti·∫øt h·ªì s∆°"));
      });

      document.getElementById("closeDetailBtn").addEventListener("click", () => {
        detailModal.classList.add("hidden");
      });
    });

    document.getElementById("checkoutBtn").addEventListener("click", () => {
      const checkedItems = document.querySelectorAll(".checkout-item:checked");

      if (checkedItems.length === 0) {
        alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n.");
        return;
      }

      const selectedIds = [];
      let total = 0;

      checkedItems.forEach(item => {
        const price = parseInt(item.dataset.price);
        const quantity = parseInt(item.dataset.quantity);
        selectedIds.push(item.dataset.id);
        total += price * quantity;
      });

      if (!confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën thanh to√°n ${selectedIds.length} s·∫£n ph·∫©m v·ªõi t·ªïng c·ªông ${total.toLocaleString()}‚Ç´?`)) return;

      fetch("http://localhost/Web%20Apple/backend/checkout.php", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        credentials: "include",
        body: JSON.stringify({ item_ids: selectedIds })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(data.message || "Thanh to√°n th√†nh c√¥ng!");
          loadCartItems();
          document.getElementById("countPurchased").textContent = parseInt(document.getElementById("countPurchased").textContent) + selectedIds.length;
        } else {
          alert("L·ªói: " + (data.message || "Kh√¥ng th·ªÉ thanh to√°n"));
        }
      })
      .catch(() => alert("L·ªói khi g·ª≠i thanh to√°n"));
    });
  </script>
</body>
</html>
